<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>
    Modern Developer :: HTML & CSS Project Assignment - Product Listing
  </title>
  <meta name="description" 
        content="Modern Developer :: HTML & CSS Project Assignment 
                 - Product Listing">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="stylesheet" 
        href="https://fonts.googleapis.com/css?family=Raleway:400,300italic">
<link   rel="stylesheet" 
        href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,900">
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/showcase.css">
  <link rel="stylesheet" href="css/topBar.css">
  <link rel="stylesheet" href="css/product.css">  
</head>
<body>

  <header class="topbar" role="banner">
    <nav class="topbar__nav" role="navigation">
      <ul class="topbar__nav__list">
        <li class="nav__list__item nav__list__item--home">
          <a class="nav__link" href="index.html" title="Home Page">
            &#8962; Home
          </a>
        </li>        
        <li class="nav__list__item">
          <a  class="nav__link" 
              href="project_2.html" 
              title="Next Project">
            Next Project &#8680;
          </a>
        </li>
      </ul>
      <p class="topbar__nav__title">6: Products List</p>
    </nav>
  </header>

    <!-- PROJECT CONTENT -->
  <article id="wrapper">
    <section id="products">
      <header>
        <div class="ribbon"><span>Fashion</span></div>
        <h1>Products List</h1>
      </header>
      <div id="products-wrapper">
          <div class="section">
            <a name="Product-1"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $10.00
                <div class="addToCart">
                  <span data-product-name="Product-1"
                        data-product-price="10"                         
                        data-product-type="1">
                      Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 1
                </span>
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
          <div class="section">
            <a name="Product-2"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $8.00
                <div class="addToCart">
                  <span data-product-name="Product-2"
                        data-product-price="8"                        
                        data-product-type="1">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 2
                </span>
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
          <div class="section rightMostSection">
            <a name="Product-3"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $135.00
                <div class="addToCart">
                  <span data-product-name="Product-3"
                        data-product-price="135"                         
                        data-product-type="1">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 3
                </span>
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.ÃŒ
                </p>
              </div>
            </div>
          </div>
          <div class="section">
            <a name="Product-4"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $1.00
                <div class="addToCart">
                  <span data-product-name="Product-4"
                        data-product-price="1">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 4
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>            
            </div>
          </div>
          <div class="section">
            <a name="Product-5"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $10.00
                <div class="addToCart">
                  <span data-product-name="Product-5"
                        data-product-price="10">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 5
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
          <div class="section rightMostSection">
            <a name="Product-6"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $20.00
                <div class="addToCart">
                  <span data-product-name="Product-6"
                        data-product-price="20"
                        data-product-type="2">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 6
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
          <div class="section">
            <a name="Product-7"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $310.00
                <div class="addToCart">
                  <span data-product-name="Product-7"
                        data-product-price="310">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 7
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
          <div class="section">
            <a name="Product-8"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $130.00
                <div class="addToCart">
                  <span data-product-name="Product-8"
                        data-product-price="130">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 8
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
          <div class="section rightMostSection">
            <a name="Product-9"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $5.00
                <div class="addToCart">
                  <span data-product-name="Product-9"
                        data-product-price="5"
                        data-product-type="3">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 9
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
          <div class="section">
            <a name="Product-10"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $101.00
                <div class="addToCart">
                  <span data-product-price="101"
                        data-product-name="Product-10">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 10
                <span class="product-promo 
                             product-promo--discount">
                  10% off
                </span>
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
          <div class="section">
            <a name="Product-11"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $45.00
                <div class="addToCart">
                  <span data-product-name="Product-11"
                        data-product-price="45">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 11
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
          <div class="section">
            <a name="Product-12"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer rightMostSection">
              <div class="price">
                Price: $10.00
                <div class="addToCart">
                  <span data-product-name="Product-12"
                        data-product-price="10">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 12
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
      </div>
    </section>
    <!-- Cart Section -->
    <section id="cart">
      <form name="cart">
      <header>
        <h1 class="cartTitle">Cart details</h1>
      </header>
      <div id="cart-wrapper">
        <div class="cartSteps">
          <a class="current">Step 1</a>
          <a>Step 2</a>
          <a>Step 3</a>
          <a>Step 4</a>
        </div>
        <div id="cart-details-table">
          <table id="cart-table" class="table">
          <tbody>
          </tbody>
          </table>
        </div>
        <div id="coupon">
        Use Coupon Code
          <input class="table__input"
                 id="couponInput" 
                 name="couponInput"
                 type="text">
          <span class="input-group-btn">
            <input class="btn" 
                   id="couponButton" 
                   type="button" 
                   value="Apply Coupon">
          </span>
          <p id="couponMessage" class="cart-coupon"></p>
        </div>
        <div id="total-cart-wrapper">
          <table class="table table-border">          
          <tbody>
          <tr>
            <td class="text-right">Sub-total:</td>
            <td class="text-left"><span id="cartSubTot"></span></td>
          </tr>
          <tr>
            <td class="text-right">Shipping:</td>
            <td class="text-left"><span id="cartShipping"></span></td>
          </tr>
          <tr id="cartCouponRow">
            <td class="text-right">Coupon(-<span id="cartCoupon"></span>%):</td>
            <td class="text-left"><span id="cartCouponVal"></span></td>
          </tr>
          <tr>
            <td class="text-right">Total:</td>
            <td class="text-left"><span id="cartTotal"></span></td>          
          </tr>
          </tbody>
          </table>
        </div>
        <div id="cart-buttons">
          <span class="input-group-btn">
            <input class="btnM keepShp"
                   type="button" 
                   value="Keep Shopping" >
          </span>
          <span class="input-group-btn">
            <input class="btnM kckOut"
                   type="button"
                   value="Checkout" >
          </span>
        </div>
      </div>
      </form>
    </section>
  </article>

<script src="js/validator.js"></script>
<script src="js/utilities.js"></script>
<script>

//var Cart = (function(window) {

  var _win = window,
      _doc = _win.document;

  var addButtons    = _doc.getElementsByClassName('addToCart'),
      cart          = $('#cart'),
      cartTable     = $('#cart-table').childNodes[1],
      cartSubTot    = $('#cartSubTot'),
      cartTotal     = $('#cartTotal'),
      cartShipp     = $('#cartShipping'),
      cartCoupon    = $('#cartCoupon'),
      cartCouponVal = $('#cartCouponVal'),
      cartCouponRow = $('#cartCouponRow'),
      couponMessage = $('#couponMessage'),
      couponButton  = $('#couponButton'),
      couponInput   = $('#couponInput'),
      len           = addButtons.length;

  var CartDB = {
      currency: '\u0024',
      shippingCost: 7,
      check: {
          subTotal: 0,
          saving: 0
      },
      promoCodes: {
        applied: null,
        coupons: { 'bigsale': 50, 'promopromo': 16, 'white': 5 },
        types: { '1': 15, '2': 8, '3': 7 },
        products: { 'product-10': 10}
      },
      products: {},
      updateCheck: function() {

          var that = this;

          var subTotal  = 0,
              saving    = 0,
              discount;

          var list = this.getProducts();

          list.map(function(product) {
              discount  = that.getDiscount(product);
              subTotal += (product.unitPrice * product.quantity);
              saving   += subTotal - calcPercentage(subTotal, discount);
          })

          this.check.subTotal = subTotal.toFixed(2);
          this.check.saving   = saving.toFixed(2);
      },
      addProd: function(product) {

          if (!this.products[product.name]) {
              this.products[product.name] = copyObj(product, {});            
          } else if (this.products[product.name]) {
            this.products[product.name]['quantity'] += 1;
          }

          this.updateCheck();

          return this.products[product.name];
      },
      updateProd: function(product) {

          var name      = product.name,
              quantity  = product.quantity;

          if (!product && !name && !quantity && !this.products[name]) {
              return false;
          }

          this.products[name]['quantity'] = parseInt(quantity);

          this.updateCheck();

          return this.products[name];
      },
      remProd: function(product) {

          var name = product.name;

          if (product && name && this.products[name]) {
              delete this.products[name];
              this.updateCheck();
              return true;
          }

          return false;
      },
      getQuantity: function(productName) {

          var total = 0;
          var products = this.products;

          if (productName && products[productName]['quantity']) {
              return products[productName]['quantity'];
          }

          for (var p in this.products) {
            if (products.hasOwnProperty(p) && products[p]['quantity']) {
                total += products[p]['quantity'];
            }
          }

          return total;
      },
      getProductsList: function() {
        return Utilities.keys(this.products);
      },
      getProduct: function(name) {
        return this.products[name] || void 0;
      },
      getProducts: function() {

          var list = [];

          for(var key in this.products) {
              if(this.products.hasOwnProperty(key)) {
                  list.push(this.products[key]);
              }
          }

        return list;
      },
      getPromoTypes: function() {
        return Utilities.keys(this.promoCodes.types);      
      },
      getPromoType: function(name) {
        return this.promoCodes.types[name];      
      },
      getPromoCode: function(code) {
        return this.promoCodes[code] || void 0;
      },
      getDiscount: function(product) {

        var promos  = this.promoCodes;
        var name    = product.name;
        var type    = product.type;

       if (!name) return 0;

        name = name.toLowerCase();

        return promos.products[name] || promos.types[type] || 0;
      },
      resetCoupon: function(callback) {

        this.promoCodes.applied = null;

        if (Utilities.isFunc(callback)) callback();
      },
      setCoupon: function(couponCode) {

        var promos = this.promoCodes;

        if (!promos.coupons[couponCode]) return void 0;

        promos.applied = promos.coupons[couponCode];

        return promos.applied;
      },
      getCouponValue: function() {

          var subTotal      = this.getSubTotal(),
              couponAmount  = this.promoCodes.applied,
              couponValue   = 0;

          // When there is not a valid coupon applied, return 0
          if (!couponAmount) return couponValue;

          couponValue = subTotal - calcPercentage(subTotal, couponAmount);

          return couponValue;
      },
      isCoupon: function() {
        return !!this.promoCodes.applied;
      },
      getShippingCost: function() {
        return this.shippingCost;
      },
      getSubTotal: function() {
        return this.check.subTotal;
      },
      getTotalSaving: function() {
        return this.check.saving;
      }
  };

    /* Functions used to manipulate products and manage the shopping cart */

    var addProduct = function(product) {

        var name      = product.getAttribute("data-product-name");
        var price     = product.getAttribute("data-product-price");
        var type      = product.getAttribute("data-product-type");
        var quantity  = product.quantity || 1;
        var newProd;

        price = parseFloat(price).toFixed(2);

        newProd = CartDB.addProd({
            name:       name,
            unitPrice:  price,
            type:       type,
            quantity:   quantity
        });

        if (newProd.quantity === 1) {
          addCartRow(newProd);
        } else {
          updateCartRow(newProd);
        }

        // When a user adds a new product to the cart which makes the 
        // total saving greater than a coupon discount it reset the coupon
        if (CartDB.getTotalSaving() > CartDB.getCouponValue()) {
            CartDB.resetCoupon(function() {
                couponMessage.innerHTML = '';
                toggle(cartCouponRow, 'none');
                updateCart();
            });
        }
       
        toggleCart();
    }

    var changeProductQuantity = function(product) {

        var name      = product.name,
            quantity  = product.quantity || 1,
            update    = product.update || false;

        var updatedProd;

        updatedProd = CartDB.updateProd({
            name:       name,
            quantity:   quantity
        });

        if (!updatedProd) throw "Unable to update this product";

        updateCartRow(updatedProd);

        toggleCart();
    }

    var removeProduct = function(product) {

        var productsList;

        if (!CartDB.remProd(product)) throw "Unable to remove this product"; 

        productsList = CartDB.getProductsList();

        if (productsList.length === 0) {
            CartDB.resetCoupon(function() {
                couponMessage.innerHTML = '';
                toggle(cartCouponRow, 'none');
            });
        }
    }



    var addCartRow = function(product) {

        var isCoupon     = CartDB.isCoupon();

        /* 
         * If a coupon is already applied to the total, sets the 
         * product's discount to 0, otherwise gets the discount
         * from the DB
         */
        var discount     = (isCoupon) ? 0 : CartDB.getDiscount(product),
            unitPrice    = getCurrency(product.unitPrice),
            unitPriceDis = getCurrency(calculateDiscount(product)),
            quantity     = product.quantity,
            finalPrice   = getCurrency(calculatePrice(product, discount)),
            partial;

        var tr   = createHTMLElem(_doc, { tag: 'TR' }),
            tr2  = createHTMLElem(_doc, { tag: 'TR' });

        var td    = createHTMLElem(_doc, { tag: 'TD', 
                                     class: 'table__td text-center' }),
            td2   = createHTMLElem(_doc, { tag: 'TD', 
                                     class: 'table__td text-left' }),
            td4   = createHTMLElem(_doc, { tag: 'TD', 
                                     class: 'table__td text-left' }),
            td3   = createHTMLElem(_doc, { tag: 'TD', 
                                     class: 'table__td text-left',
                                     text: 'Unit price: ' }),
            td5   = createHTMLElem(_doc, { tag: 'TD', 
                                     class: 'table__td text-left' }),
            td6   = createHTMLElem(_doc, { tag: 'TD', 
                                    class: 'table__td text-right' }),
            tdDisc  = createHTMLElem(_doc, { tag: 'TD', 
                                       class: 'table__td text-left' }),
            tdSepa  = createHTMLElem(_doc, { tag: 'TD', 
                                       class: 'table__td--separator',
                                       colspan: '7'});

        var a = createHTMLElem(_doc, { 
            tag: 'A',
            src: '#'
        });

        var img  = createHTMLElem(_doc, { 
            tag: 'img', 
            class: 'table__img-thumbnail',
            src: 'images/64x64.png',
            alt: 'Product Image',
            title: 'Product Image' 
        });

        var aProd = createHTMLElem(_doc, { 
            tag: 'A', 
            href: '#' + product.name,
            text: Utilities.replaceAll(product.name, '-', ' ')
        });

        var inputTxt = createHTMLElem(_doc, { 
            tag: 'input', 
            class: 'table__input table__input--text',
            id: 'input-' + Utilities.replaceAll(product.name, ' ', '-'),
            name: 'input-' + Utilities.replaceAll(product.name, ' ', '-'),
            type: 'text',
            value: quantity
        });

        var spn = createHTMLElem(_doc, {
                tag: 'SPAN', 
                class: 'input-group-btn'
            }),
            spnPrice = createHTMLElem(_doc, {
                tag: 'SPAN',
                class: (discount) ? 'cart-product-discount ' + 
                                    ' cart-product-discount--price' 
                                  : '',
                text: unitPrice
            }),
            spnPriceDiscount = createHTMLElem(_doc, {
                tag: 'SPAN',
                text: ' ' + unitPriceDis
            }),
            spnDiscount = createHTMLElem(_doc, {
                tag: 'SPAN', 
                class: 'cart-product-discount',
                text: discount + '% off'
            }),
            spnPartial = createHTMLElem(_doc, {
                tag: 'SPAN', 
                id: 'partial-'+ Utilities.replaceAll(product.name, ' ', '-'),
                name: 'partial-'+ Utilities.replaceAll(product.name, ' ', '-'),
                text:  finalPrice
            });

        var removeButton = createHTMLElem(_doc, { 
                tag: 'input', 
                class: 'btn btn-red',
                id: 'remove-' + Utilities.replaceAll(product.name, ' ', '-'),
                type: 'button',
                value: 'Remove'
            });


        a.appendChild(img)
        td.appendChild(a);
        td2.appendChild(aProd);
        td3.appendChild(spnPrice);
        td4.appendChild(inputTxt);
        spn.appendChild(removeButton);
        td5.appendChild(spn);
        td6.appendChild(spnPartial);

        if (discount > 0) {
            td3.appendChild(spnPriceDiscount);
            tdDisc.appendChild(spnDiscount);
        }

        tr2.appendChild(td); 
        tr2.appendChild(td2); 
        tr2.appendChild(td3); 
        tr2.appendChild(tdDisc);
        tr2.appendChild(td4); 
        tr2.appendChild(td5); 
        tr2.appendChild(td6);  

        tr.appendChild(tdSepa);

        cartTable.appendChild(tr);
        cartTable.appendChild(tr2);


        removeButton.addEventListener('click', function(event) {
            removeProduct(product);
            removeCartRow(this.parentNode.parentNode.parentNode);
        });

        inputTxt.addEventListener('change', function(event) {

            var id    = this.getAttribute('id'),
                value = this.value,
                name  = Utilities.replaceAll(id,'input-','');


            if (!Utilities.isInt(value) || (value < 0)) {
                // restore input's value 
                this.value = product.quantity;
            } else if (value === '0') {
                removeProduct(product);
                removeCartRow(this.parentNode.parentNode);
                return;
            }

            product.quantity = this.value;

            changeProductQuantity(product);         
        });
    }

    var updateCartRow = function(product) {

      var input   = $('#input-' + product.name);
      var partial = $('#partial-' + product.name);

      input.value = product.quantity;
      partial.innerHTML = getCurrency(calculatePrice(product));
    }

    var removeCartRow = function(row) {

        var sep = row.previousSibling;
        
        cartTable.deleteRow(row.rowIndex); 
        cartTable.deleteRow(sep.rowIndex); // Delete the separator row too

        toggleCart();
    }

    var updateCart = function() {

      var prodList = CartDB.getProductsList();

      if (!prodList || prodList.length === 0) return;

      // remove all products node
      while (cartTable.firstChild) {
        cartTable.removeChild(cartTable.firstChild);
      }
      // add again all products node
      prodList.map(function(name) {
        addCartRow(CartDB.getProduct(name));
      });

      toggleCart();
    }

    function toggleCart() {

        var quantity = CartDB.getQuantity();

        if (quantity === 0) {
            toggle(cart, 'none');
        } else if (quantity === 1) {
            toggle(cart, 'block');
        }

      cartCheck();
    }

    var calculatePrice = function(product, discount) {

      var unitPrice = product.unitPrice,
          quantity  = product.quantity,
          discount  = (discount === 0) ? 0 : CartDB.getDiscount(product);

      var subTotal = unitPrice * quantity;

      return calcPercentage(subTotal, discount);
    }

    var calculateDiscount = function(product) {

      var unitPrice = product.unitPrice,
          discount;

      discount = CartDB.getDiscount(product);

      return calcPercentage(unitPrice, discount);
    }

    function cartCheck() {

        var total         = 0,
            subTotal      = CartDB.getSubTotal(),
            shipping      = CartDB.getShippingCost(),
            saving        = CartDB.getTotalSaving(),
            couponValue   = CartDB.getCouponValue(),
            totalSaving   = (saving > couponValue) ? saving : couponValue;      

        subTotal = (saving > couponValue) ? subTotal - saving : subTotal;
        total    = subTotal + shipping - totalSaving;

        cartSubTot.innerHTML = getCurrency(subTotal);
        cartTotal.innerHTML  = getCurrency(parseFloat(total).toFixed(2));
        cartCouponVal.innerHTML = getCurrency(couponValue.toFixed(2));
    }

    var verifyCoupon = function() {

        var coupon = couponInput.value;
        var couponAmount = CartDB.setCoupon(coupon),
            couponValue  = 0;

        var subTotal = CartDB.getSubTotal(),
            saving   = CartDB.getTotalSaving();

        couponInput.value = '';

        if (!couponAmount) {
            couponMessage.innerHTML = coupon + ' - invalid coupon code';
            return;
        }

        couponValue = subTotal - calcPercentage(subTotal, couponAmount);

        if (couponValue < saving) {
            couponMessage.innerHTML = 'The current promo is better than your ' +
                                      'coupon \'' + coupon + '\' ' +
                                      '-' + couponAmount + '% off';
            return;
        }

        cartCoupon.innerHTML = couponAmount;
        couponMessage.innerHTML = 'coupon \'' + coupon + '\' -' +
                                   couponAmount + '% off';
        updateCart();
        toggle(cartCouponRow, 'table-row');
    }

    var getCurrency = function(value, separator) {

        var curr = CartDB.currency;

        return curr + currency(value, separator);
    }

    var currency = function(amount, separator) {

        var amnt      = amount.toString();
        var len       = amnt.length;
        var separator = separator || ",";
        var decimal   = "";

        var remainder,
            partial;

        if (amnt.indexOf(".") !== -1) {
            decimal = amnt.substr(amnt.indexOf("."), 3);
            amnt    = amnt.substr(0, amnt.indexOf("."));
            len    -= 3; // remove decimal part from total length
        }

        if (len < 4) {
            return amnt + decimal;
        } else {
            remainder = amnt.substr(0, len - 3);
            partial   = amnt.substr(len - 3, 3);

            return currency(remainder, separator) + separator + partial + decimal;
        }
    }

    /* Helper and Utility functions */

    function $(selector) {
        return _doc.querySelector(selector);
    }

    function $$(selector) {
        return _doc.querySelectorAll(selector);
    }

    var map = function(array, callback) {

        var newArray = [];

        var i   = 0,
            len = array.length;

        for (i = 0; i < len; i++) {
            newArray[i] = callback(array[i], i);
        }
        
        return newArray;
    }

    function calcPercentage(value, percentage) {
      return (value - ((percentage / 100) * value)).toFixed(2);
    }

    function copyObj(first, second) {
      for (var p in first) {
        if (first.hasOwnProperty(p)) {
            second[p] = first[p];
        }
      }
      return second;
    }

    function toggle(element, visibility) {

        var display     = (window.getComputedStyle(element, null).display);
        var visibility  = visibility || 'block';

        // if current display property is = to the visibility param, do nothing
        if (element.style.display === visibility) return;
        
        element.style.display = (display === 'none') ? visibility : 'none';
    }

    function createHTMLElem(_doc, obj) {

      var elem = _doc.createElement(obj.tag);
      var text = ('text' in obj) ? _doc.createTextNode(obj['text']) : null;

      if (text) elem.appendChild(text);

      // it deletes unused properties 
      delete obj.tag;
      delete obj.text;

      for (var attr in obj) {
          if (obj.hasOwnProperty(attr)) {
              elem.setAttribute(attr, obj[attr]);
          }
      }

      return elem;
    }

    // This function ensures that a function will be called exactly once
    function once(fn) {

      var _once = false;

      return function () {
          return _once ? void 0 : ((_once = true), fn.apply(this, arguments))
      }
    }

    function initialize() {

        // Initialize promos for products of a specific type
        var types = CartDB.getPromoTypes();

        types.map(function(type) {

            var off  = CartDB.getPromoType(type);
            var list;

            list = $$('span[data-product-type="'+ type +'"]');

            Array.prototype.map.call(list, function(product) {  

              var span = createHTMLElem(_doc, {
                          tag: 'SPAN', 
                          class: 'product-promo',
                          text : '[Special Type ' + type +'] -'
                                  + off + '% off'
                         });
              // Select parent node
              var pNode = product.parentNode.parentNode.nextSibling.nextSibling;

              pNode.appendChild(span);
            });
        });

      // Add an Event listener for each 'ADD TO CART' button
      while(len--) {
          addButtons[len].addEventListener('click', function(event) {
              addProduct(this.firstChild.nextSibling);
          })
      }

      // Set fixed shipping cost
      cartShipp.innerHTML = getCurrency(CartDB.getShippingCost());

      couponButton.addEventListener('click', verifyCoupon);
    }

    /* Public API
    return {
      initialize: once(initialize)
    }

}

//)(window);

// Initialize the shopping cart
Cart.initialize();*/
initialize();
</script>


</body>
</html>