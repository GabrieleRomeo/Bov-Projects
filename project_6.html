<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>
    Modern Developer :: HTML & CSS Project Assignment - Product Listing
  </title>
  <meta name="description" 
        content="Modern Developer :: HTML & CSS Project Assignment 
                 - Product Listing">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="stylesheet" 
        href="https://fonts.googleapis.com/css?family=Raleway:400,300italic">
<link   rel="stylesheet" 
        href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,900">
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/showcase.css">
  <link rel="stylesheet" href="css/topBar.css">
  <link rel="stylesheet" href="css/product.css">  
</head>
<body>

  <header class="topbar" role="banner">
    <nav class="topbar__nav" role="navigation">
      <ul class="topbar__nav__list">
        <li class="nav__list__item nav__list__item--home">
          <a class="nav__link" href="index.html" title="Home Page">
            &#8962; Home
          </a>
        </li>        
        <li class="nav__list__item">
          <a  class="nav__link" 
              href="project_2.html" 
              title="Next Project">
            Next Project &#8680;
          </a>
        </li>
      </ul>
      <p class="topbar__nav__title">6: Products List</p>
    </nav>
  </header>

    <!-- PROJECT CONTENT -->
  <article id="wrapper">
    <section id="products">
      <header>
        <div class="ribbon"><span>Fashion</span></div>
        <h1>Products List</h1>
      </header>
      <div id="products-wrapper">
          <div class="section">
            <a name="Product-1"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $10.00
                <div class="addToCart">
                  <span data-product-name="Product-1"
                        data-product-price="10"                         
                        data-product-type="1">
                      Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 1
                </span>
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
          <div class="section">
            <a name="Product-2"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $8.00
                <div class="addToCart">
                  <span data-product-name="Product-2"
                        data-product-price="8"                        
                        data-product-type="1">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 2
                </span>
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
          <div class="section rightMostSection">
            <a name="Product-3"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $135.00
                <div class="addToCart">
                  <span data-product-name="Product-3"
                        data-product-price="135"                         
                        data-product-type="1">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 3
                </span>
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.ÃŒ
                </p>
              </div>
            </div>
          </div>
          <div class="section">
            <a name="Product-4"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $1.00
                <div class="addToCart">
                  <span data-product-name="Product-4"
                        data-product-price="1">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 4
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>            
            </div>
          </div>
          <div class="section">
            <a name="Product-5"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $10.00
                <div class="addToCart">
                  <span data-product-name="Product-5"
                        data-product-price="10">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 5
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
          <div class="section rightMostSection">
            <a name="Product-6"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $20.00
                <div class="addToCart">
                  <span data-product-name="Product-6"
                        data-product-price="20"
                        data-product-type="2">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 6
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
          <div class="section">
            <a name="Product-7"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $310.00
                <div class="addToCart">
                  <span data-product-name="Product-7"
                        data-product-price="310">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 7
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
          <div class="section">
            <a name="Product-8"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $130.00
                <div class="addToCart">
                  <span data-product-name="Product-8"
                        data-product-price="130">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 8
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
          <div class="section rightMostSection">
            <a name="Product-9"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $5.00
                <div class="addToCart">
                  <span data-product-name="Product-9"
                        data-product-price="5"
                        data-product-type="3">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 9
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
          <div class="section">
            <a name="Product-10"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $101.00
                <div class="addToCart">
                  <span data-product-price="101"
                        data-product-name="Product-10">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 10
                <span class="product-promo 
                             product-promo--discount">
                  10% off
                </span>
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
          <div class="section">
            <a name="Product-11"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer">
              <div class="price">
                Price: $45.00
                <div class="addToCart">
                  <span data-product-name="Product-11"
                        data-product-price="45">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 11
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
          <div class="section">
            <a name="Product-12"></a>
            <span class="thumb">
              <img src="images/278x278.png">
            </span>
            <div class="sectionContainer rightMostSection">
              <div class="price">
                Price: $10.00
                <div class="addToCart">
                  <span data-product-name="Product-12"
                        data-product-price="10">
                    Add to Cart
                  </span>
                </div>
              </div>
              <div class="title">
                Product 12
              </div>
              <div class="product-description">
                <p class="product-description__paragraph">
                Lorem ipsum dolor sit amet, consectetuer adipiscing elit. 
                Aenean commodo ligula eget dolor. Aenean massa.
                </p>
              </div>
            </div>
          </div>
      </div>
    </section>
    <!-- Cart Section -->
    <section id="cart">
      <form name="cart">
      <header>
        <h1 class="cartTitle">Cart details</h1>
      </header>
      <div id="cart-wrapper">
        <div class="cartSteps">
          <a class="current">Step 1</a>
          <a>Step 2</a>
          <a>Step 3</a>
          <a>Step 4</a>
        </div>
        <div id="cart-details-table">
          <table id="cart-table" class="table">
          <tbody>
          </tbody>
          </table>
        </div>
        <div id="coupon">
        Use Coupon Code
          <input class="table__input"
                 id="couponInput" 
                 name="couponInput"
                 type="text">
          <span class="input-group-btn">
            <input class="btn" 
                   id="couponButton" 
                   type="button" 
                   value="Apply Coupon">
          </span>
          <p id="couponMessage" class="cart-coupon"></p>
          Valid coupon codes: { 'bigsale': 50, 'promopromo': 16, 'white': 5 }
        </div>
        <div id="total-cart-wrapper">
          <table class="table table-border">          
          <tbody>
          <tr>
            <td class="text-right">Sub-total:</td>
            <td class="text-left"><span id="cartSubTot"></span></td>
          </tr>
          <tr>
            <td class="text-right">Shipping:</td>
            <td class="text-left"><span id="cartShipping"></span></td>
          </tr>
          <tr id="cartCouponRow">
            <td class="text-right">Coupon(-<span id="cartCoupon"></span>%):</td>
            <td class="text-left"><span id="cartCouponVal"></span></td>
          </tr>
          <tr>
            <td class="text-right">Total:</td>
            <td class="text-left"><span id="cartTotal"></span></td>          
          </tr>
          </tbody>
          </table>
        </div>
        <div id="cart-buttons">
          <span class="input-group-btn">
            <input class="btnM keepShp"
                   type="button" 
                   value="Keep Shopping" >
          </span>
          <span class="input-group-btn">
            <input class="btnM kckOut"
                   type="button"
                   value="Checkout" >
          </span>
        </div>
      </div>
      </form>
    </section>
  </article>

<script src="js/validator.js"></script>
<script src="js/utilities.js"></script>
<script>

//var Cart = (function(window) {

  var _win = window,
      _doc = _win.document;

  var addButtons    = _doc.getElementsByClassName('addToCart'),
      cart          = $('#cart'),
      cartTable     = $('#cart-table').childNodes[1],
      cartSubTot    = $('#cartSubTot'),
      cartTotal     = $('#cartTotal'),
      cartShipp     = $('#cartShipping'),
      cartCoupon    = $('#cartCoupon'),
      cartCouponVal = $('#cartCouponVal'),
      cartCouponRow = $('#cartCouponRow'),
      couponMessage = $('#couponMessage'),
      couponButton  = $('#couponButton'),
      couponInput   = $('#couponInput'),
      len           = addButtons.length;

  var CartDB = {
      currency: '\u0024',
      shippingCost: 7,
      check: {
          subTotal: 0,
          saving: 0
      },
      promoCodes: {
        applied: null,
        coupons: { 'bigsale': 50, 'promopromo': 16, 'white': 5 },
        types: { '1': 15, '2': 8, '3': 7 },
        products: { 'product-10': 10}
      },
      products: {},
      items: [],
      updateCheck: function() {

          var that = this;

          var subTotal  = 0,
              saving    = 0,
              discount;

          var list = this.getProducts();

          list.map(function(product) {
              discount  = that.getDiscount(product);
              subTotal += (product.unitPrice * product.quantity);
              saving   += subTotal - calcPercentage(subTotal, discount);
          })

          this.check.subTotal = subTotal.toFixed(2);
          this.check.saving   = saving.toFixed(2);
      },
      addProd: function(product) {
          //this.productsDb.push(product);
          if (!this.products[product.name]) {
              this.products[product.name] = copyObj(product, {});            
          } else if (this.products[product.name]) {
            this.products[product.name]['quantity'] += 1;
          }

          this.updateCheck();

          return this.products[product.name];
      },
      updateProd: function(product) {

          var name      = product.name,
              quantity  = product.quantity;

          if (!product && !name && !quantity && !this.products[name]) {
              return false;
          }

          this.products[name]['quantity'] = parseInt(quantity);

          this.updateCheck();

          return this.products[name];
      },
      remProd: function(product) {

          var name = product.name;

          if (product && name && this.products[name]) {
              delete this.products[name];
              this.updateCheck();
              return true;
          }

          return false;
      },
      getQuantity: function(productName) {

          var total = 0;
          var products = this.products;

          if (productName && products[productName]['quantity']) {
              return products[productName]['quantity'];
          }

          for (var p in this.products) {
            if (products.hasOwnProperty(p) && products[p]['quantity']) {
                total += products[p]['quantity'];
            }
          }

          return total;
      },
      getItems: function() {
          return this.items;
      },
      getProductsList: function() {
        return Utilities.keys(this.products);
      },
      getProduct: function(name) {
        return this.products[name] || void 0;
      },
      getProducts: function() {

          var list = [];

          for(var key in this.products) {
              if(this.products.hasOwnProperty(key)) {
                  list.push(this.products[key]);
              }
          }

        return list;
      },
      getPromoTypes: function() {
        return Utilities.keys(this.promoCodes.types);      
      },
      getPromoType: function(name) {
        return this.promoCodes.types[name];      
      },
      getPromoCode: function(code) {
        return this.promoCodes[code] || void 0;
      },
      getDiscount: function(product) {

        var promos  = this.promoCodes;
        var name    = product.name.toLowerCase();
        var type    = product.type;

        // When a coupon was applied, returns 0 
        if (truthy(promos.applied)) {
            return 0;
        }

        // First, it checks for a promo for the provided product
        // then it looks for its type, in the end returs 0
        return promos.products[name] || promos.types[type] || 0;
      },
      resetCoupon: function() {
        this.promoCodes.applied = null;
      },
      checkCoupon: function(coupon) {

        var promos = this.promoCodes;

        var subTotal     = 0,
            saving       = 0,
            off          = 0,
            couponSaving = 0;

        // if the provided promo does not exist, it returns -1
        if (!existy(promos.coupons[coupon])) {
            // It reset a current promo (if any)
            promos.applied = null;
            return -1;
        }

        /* 
         * It first checks if the coupon makes the total price less than the  
         * total price with the current promo
         */
        off          = promos.coupons[coupon];
        subTotal     = this.getSubTotal();
        saving       = this.getSaving();
        couponSaving = subTotal - calcPercentage(subTotal, off);

        // if the coupon saving is less then the normal saving, it returns 0
        if (couponSaving < saving) return 0;

        // Otherwise, save the current promo
        promos.applied = off;

        // returns its actual coupon's value, in percentage
        return off;
      },
      getCouponValue: function() {

          var subTotal      = this.getSubTotal(),
              couponAmount  = this.promoCodes.applied,
              couponValue   = 0;

          // When there is not a valid coupon applied, return 0
          if (!couponAmount) return couponValue;

          couponValue = subTotal - calcPercentage(subTotal, couponAmount);

          return couponValue;
      },
      isCoupon: function() {
        return !!this.promoCodes.applied;
      },
      getShippingCost: function() {
        return this.shippingCost;
      },
      setSubTotal: function(subTotal) {
          this.check.subTotal = subTotal;
      },
      getSubTotal: function() {
        return this.check.subTotal;
      },
      setSaving: function(saving) {
          this.check.saving = saving;
      },
      getSaving: function() {
        return this.check.saving;
      }
  };

    /* Functions used to manipulate products and manage the shopping cart */

    function Product(name, type, unitPrice) {
        this.name       = name;
        this.type       = type;
        this.unitPrice  = unitPrice;
        this.quantity   = 1;

         // Returns the total saving when a product has a promo
        this.getSaving = function() {

            var discount = CartDB.getDiscount(this);
            var subTotal = this.getSubTotal();

            return parseFloat(subTotal - calcPercentage(subTotal, discount));
        };

        // Returns the promo for the current product or 0
        this.getOff = function() {
            return CartDB.getDiscount(this);
        }

        // Returns the new Unit price
        this.getNewPrice = function() {

          var off       = this.getOff();
          var unitPrice = this.unitPrice;

          return parseFloat(calcPercentage(unitPrice, off));
        }

        // Returns the actual subTotal for this product
        this.getSubTotal = function() {
            return parseFloat(this.unitPrice * this.quantity);
        };

        // returns an HTML representation of a product
        this.HTMLrender = function() {

            var name     = Utilities.replaceAll(this.name, '-', ' ');
            var discount = this.getOff();
            var saving   = this.getSaving();
            var newPrice = this.getNewPrice();
            var newSubT  = (this.getSubTotal() - this.getSaving()).toFixed(2);

            var html = '';

            html += '<tr>                                                  ';
            html += '  <td class="table__td--separator" colspan="7"></td>  ';
            html += '</tr>                                                 ';
            html += '<tr>                                                  ';
            html += '  <td class="table__td text-center">                  ';
            html += '    <a src="#">                                       ';
            html += '      <img class="table__img-thumbnail"               ';
            html += '           src="images/64x64.png"                     ';
            html += '           alt="Product Image"                        ';
            html += '          title="Product Image">                      ';
            html += '    </a>                                              ';
            html += '  </td>                                               ';
            html += '  <td class="table__td text-left">                    ';
            html += '    <a href="#'+ this.name + '">' + name +'</a>       ';
            html += '  </td>                                               ';
            html += '  <td class="table__td text-left">                    ';
            html += '    Unit price:                                       ';

            if (truthy(discount)) {
                html += '    <span class="cart-product-discount             ';
                html += '                 cart-product-discount--price">    ';
                html += '      '+ getCurrency(this.unitPrice) +'            ';
                html += '    </span>                                        ';
                html += '    <span>'+ getCurrency(newPrice) +'</span>       ';
                html += '  </td>                                            ';
                html += '  <td class="table__td text-left">                 ';
                html += '    <span class="cart-product-discount">           ';
                html += '      '+ discount +'% off                          ';
                html += '    </span>                                        ';
            } else {
                html += '    <span>'+ getCurrency(this.unitPrice) +'</span> ';
                html += '  </td>                                            ';
                html += '  <td class="table__td text-left"></td>            ';
            }

            html += '  </td>                                               ';
            html += '  <td class="table__td text-left">                    ';
            html += '    <input class="table__input                        ';
            html += '                  table__input--text"                 ';
            html += '           id="input_'+ this.name + '"                ';
            html += '           name="input-'+ this.name + '"              ';
            html += '           type="text"                                ';
            html += '           data-product-name="' + this.name +'"       ';
            html += '           value="' + this.quantity +'">              ';
            html += '  </td>                                               ';
            html += '  <td class="table__td text-left">                    ';
            html += '    <span class="input-group-btn">                    ';
            html += '    <input class="btn btn-red"                        ';
            html += '           id="remove_'+ this.name + '"               ';
            html += '           type="button"                              ';
            html += '           data-product-name="' + this.name +'"       ';
            html += '           value="Remove">                            ';
            html += '    </span>                                           ';
            html += '  </td>                                               ';
            html += '  <td class="table__td text-right">                   ';
            html += '    <span id="partial-'+ this.name + '"               ';
            html += '          name="partial-'+ this.name + '">            ';
            html +=  getCurrency(discount ? newSubT : this.getSubTotal())   ;
            html += '    </span>                                           ';
            html += '  </td>                                               ';
            html += '</tr>                                                 ';

            return html;
        };
    }

    var addProduct2 = function(htmlElement) {
        var name  = htmlElement.getAttribute("data-product-name");
        var type  = htmlElement.getAttribute("data-product-type");
        var price = htmlElement.getAttribute("data-product-price");
        var table = CartDB.items;
        var newP  = new Product(name, type, price);

        // It tries to retrieve the current product from the Db
        var items = filter(table, function(product) {
                return product.name === name;
        });
        
        // The current product isn't in the cart list, then adds it
        if (items.length === 0) {
            table.push(newP);
        } else {
          items[0].quantity += 1;
        }

       rebuildCart();
    }


    var addProduct = function(product) {
        addProduct2(product);
 /*      var name      = product.getAttribute("data-product-name");
        var price     = product.getAttribute("data-product-price");
        var type      = product.getAttribute("data-product-type");
        var quantity  = product.quantity || 1;
        var newProd;

        price = parseFloat(price).toFixed(2);

        newProd = CartDB.addProd({
            name:       name,
            unitPrice:  price,
            type:       type,
            quantity:   quantity
        });

        if (newProd.quantity === 1) {
          addCartRow(newProd);
        } else {
          updateCartRow(newProd);
        }

        // When a user adds a new product to the cart which makes the 
        // total saving greater than a coupon discount it reset the coupon
        if (CartDB.getTotalSaving() > CartDB.getCouponValue()) {
            CartDB.resetCoupon(function() {
                couponMessage.innerHTML = '';
                toggle(cartCouponRow, 'none');
                updateCart();
            });
        }

        toggleCart(1);*/
    }

    var changeProductQuantity = function(name, newQuantity) {

        var table = CartDB.items;

        // Gets the specific product
        var item = filter(table, function(product) {
            return product.name === name;
        });

        // Sets its new quantity
        item[0].quantity = newQuantity;
        
        // rebuild the cart
        rebuildCart();
    }

    var removeProduct = function(name) {

        var db    = CartDB;
        var table = db.items;

        /*
         * Since the [where] function returs a new Array containing only
         * the resulting elements which make the predicate True, we can 
         * exploit this behavior for associate the resulting Array 
         * to the origin
         */
        db.items = Select(/* all */).from(table).where(function(product) {
            return product.name !== name;
        });

        // rebuild the cart
        rebuildCart();
/*
        productsList = CartDB.getProductsList();

        if (productsList.length === 0) {
            CartDB.resetCoupon(function() {
                couponMessage.innerHTML = '';
                toggle(cartCouponRow, 'none');
            });
        }
*/
    }
/*
    var addCartRow = function(product) {

        var isCoupon     = CartDB.isCoupon();

        /* 
         * If a coupon is already applied to the total, sets the 
         * product's discount to 0, otherwise gets the discount
         * from the DB
         
        var discount     = (isCoupon) ? 0 : CartDB.getDiscount(product),
            unitPrice    = getCurrency(product.unitPrice),
            unitPriceDis = getCurrency(calculateDiscount(product)),
            quantity     = product.quantity,
            finalPrice   = getCurrency(calculatePrice(product, discount)),
            partial;

        var list = ['tr']

        var tr   = createHTMLElem(_doc, { tag: 'TR' }),
            tr2  = createHTMLElem(_doc, { tag: 'TR' });

        var td    = createHTMLElem(_doc, { tag: 'TD', 
                                     class: 'table__td text-center' }),
            td2   = createHTMLElem(_doc, { tag: 'TD', 
                                     class: 'table__td text-left' }),
            td4   = createHTMLElem(_doc, { tag: 'TD', 
                                     class: 'table__td text-left' }),
            td3   = createHTMLElem(_doc, { tag: 'TD', 
                                     class: 'table__td text-left',
                                     text: 'Unit price: ' }),
            td5   = createHTMLElem(_doc, { tag: 'TD', 
                                     class: 'table__td text-left' }),
            td6   = createHTMLElem(_doc, { tag: 'TD', 
                                    class: 'table__td text-right' }),
            tdDisc  = createHTMLElem(_doc, { tag: 'TD', 
                                       class: 'table__td text-left' }),
            tdSepa  = createHTMLElem(_doc, { tag: 'TD', 
                                       class: 'table__td--separator',
                                       colspan: '7'});

        var a = createHTMLElem(_doc, { 
            tag: 'A',
            src: '#'
        });

        var img  = createHTMLElem(_doc, { 
            tag: 'img', 
            class: 'table__img-thumbnail',
            src: 'images/64x64.png',
            alt: 'Product Image',
            title: 'Product Image' 
        });

        var aProd = createHTMLElem(_doc, { 
            tag: 'A', 
            href: '#' + product.name,
            text: Utilities.replaceAll(product.name, '-', ' ')
        });

        var inputTxt = createHTMLElem(_doc, { 
            tag: 'input', 
            class: 'table__input table__input--text',
            id: 'input-' + Utilities.replaceAll(product.name, ' ', '-'),
            name: 'input-' + Utilities.replaceAll(product.name, ' ', '-'),
            type: 'text',
            value: quantity
        });

        var spn = createHTMLElem(_doc, {
                tag: 'SPAN', 
                class: 'input-group-btn'
            }),
            spnPrice = createHTMLElem(_doc, {
                tag: 'SPAN',
                class: (discount) ? 'cart-product-discount ' + 
                                    ' cart-product-discount--price' 
                                  : '',
                text: unitPrice
            }),
            spnPriceDiscount = createHTMLElem(_doc, {
                tag: 'SPAN',
                text: ' ' + unitPriceDis
            }),
            spnDiscount = createHTMLElem(_doc, {
                tag: 'SPAN', 
                class: 'cart-product-discount',
                text: discount + '% off'
            }),
            spnPartial = createHTMLElem(_doc, {
                tag: 'SPAN', 
                id: 'partial-'+ Utilities.replaceAll(product.name, ' ', '-'),
                name: 'partial-'+ Utilities.replaceAll(product.name, ' ', '-'),
                text:  finalPrice
            });

        var removeButton = createHTMLElem(_doc, { 
                tag: 'input', 
                class: 'btn btn-red',
                id: 'remove-' + Utilities.replaceAll(product.name, ' ', '-'),
                type: 'button',
                value: 'Remove'
            });


        a.appendChild(img)
        td.appendChild(a);
        td2.appendChild(aProd);
        td3.appendChild(spnPrice);
        td4.appendChild(inputTxt);
        spn.appendChild(removeButton);
        td5.appendChild(spn);
        td6.appendChild(spnPartial);

        if (discount > 0) {
            td3.appendChild(spnPriceDiscount);
            tdDisc.appendChild(spnDiscount);
        }

        tr2.appendChild(td); 
        tr2.appendChild(td2); 
        tr2.appendChild(td3); 
        tr2.appendChild(tdDisc);
        tr2.appendChild(td4); 
        tr2.appendChild(td5); 
        tr2.appendChild(td6);  

        tr.appendChild(tdSepa);

        cartTable.appendChild(tr);
        cartTable.appendChild(tr2);


        removeButton.addEventListener('click', function(event) {
            removeProduct(product);
            removeCartRow(this.parentNode.parentNode.parentNode);
        });

        inputTxt.addEventListener('change', function(event) {

            var id    = this.getAttribute('id'),
                value = this.value,
                name  = Utilities.replaceAll(id,'input-','');


            if (!Utilities.isInt(value) || (value < 0)) {
                // restore input's value 
                this.value = product.quantity;
            } else if (value === '0') {
                removeProduct(product);
                removeCartRow(this.parentNode.parentNode);
                return;
            }

            product.quantity = this.value;

            changeProductQuantity(product);         
        });
    }

    var updateCartRow = function(product) {

      var input   = $('#input-' + product.name);
      var partial = $('#partial-' + product.name);

      input.value = product.quantity;
      partial.innerHTML = getCurrency(calculatePrice(product));
    }

    var removeCartRow = function(row) {

        var sep = row.previousSibling;
        
        cartTable.deleteRow(row.rowIndex); 
        cartTable.deleteRow(sep.rowIndex); // Delete the separator row too

        toggleCart();
    }
*/
    var rebuildCart = function() {

        var prodList = CartDB.getItems();
        var subTotal = 0;
        var saving   = 0;

        // add all products to the Cart
        cartTable.innerHTML = map(prodList, function(product) {
            // Updates the bills
            subTotal += product.getSubTotal();
            saving   += product.getSaving();
            return product.HTMLrender();
        }).join('');

        // Update subTotal and Saving
        CartDB.setSubTotal(subTotal);
        CartDB.setSaving(saving);

        // Update the Shopping Cart check
        cartCheck(subTotal, saving);

        // Refresh the User Interface
        refreshUI();
    }

    var refreshUI = function() {

        var db       = CartDB;
        var subTotal = db.getSubTotal();

        // The Cart is empty
        if (subTotal === 0) {
            // We can safely reset a previous coupon (if any)
            db.resetCoupon();
            // Hide Coupon details (if any)
            couponMessage.innerHTML = '';
            toggle(cartCouponRow, 'node');

            // Hide the Shopping Cart
            toggle(cart, 'none');

            return; // Stop
        }

        // Toggles the Shopping Cart (if necessary) 
        toggle(cart, 'block');

    }

    var updateCart = function() {

      var prodList = CartDB.getProductsList();

      if (!prodList || prodList.length === 0) return;

      // remove all products node
      while (cartTable.firstChild) {
        cartTable.removeChild(cartTable.firstChild);
      }
      // add again all products node
      prodList.map(function(name) {
        addCartRow(CartDB.getProduct(name));
      });

      toggleCart();
    }

    function toggleCart(quantity) {

        if (quantity === 0) {
            toggle(cart, 'none');
        } else if (quantity === 1) {
            toggle(cart, 'block');
        }

    }

    var calculatePrice = function(product, discount) {

      var unitPrice = product.unitPrice,
          quantity  = product.quantity,
          discount  = (discount === 0) ? 0 : CartDB.getDiscount(product);

      var subTotal = unitPrice * quantity;

      return calcPercentage(subTotal, discount);
    }

    var calculateDiscount = function(product) {

      var unitPrice = product.unitPrice,
          discount;

      discount = CartDB.getDiscount(product);

      return calcPercentage(unitPrice, discount);
    }

    function cartCheck(subTotal, saving) {

        var total         = 0,
            shipping      = CartDB.getShippingCost(),
            couponValue   = CartDB.getCouponValue(),
            totalSaving   = (saving > couponValue) ? saving : couponValue;      

        subTotal = (saving > couponValue) ? subTotal - saving : subTotal;
        total    = subTotal + shipping - totalSaving;

        cartSubTot.innerHTML = getCurrency(subTotal);
        cartTotal.innerHTML  = getCurrency(parseFloat(total).toFixed(2));
        cartCouponVal.innerHTML = getCurrency(couponValue.toFixed(2));
    }

    var checkCoupon = function(coupon) {

        var coupon = couponInput.value;
        var off    = CartDB.checkCoupon(coupon);

        // Initial reset
        couponInput.value = '';

        /*
         *  The checkCoupon method returs:
         * 
         *  -1  if the coupon was not found
         *
         *   0  if the coupon does not make the total price less than the 
         *      total price with the current promo 
         *
         *  {n} if the coupon was applied because it fulfills all the 
         *      requirements 
         */

        switch(off) {

            case -1:

                couponMessage.innerHTML = coupon + ' - invalid coupon code';
                break;

            case 0:

                couponMessage.innerHTML = 'The current promo is better ' + 
                                          'than your coupon ' +
                                          '[ <em>' + coupon +'</em> ]';
                break;

            default:

                cartCoupon.innerHTML = off;
                couponMessage.innerHTML = 'coupon [' + coupon + '] -' +
                                           off + '% off';
                rebuildCart();
                toggle(cartCouponRow, 'table-row');
                break;
        }

    }

    var getCurrency = function(value, separator) {

        var curr = CartDB.currency;

        return curr + currency(value, separator);
    }

    var currency = function(amount, separator) {

        var amnt      = amount.toString();
        var len       = amnt.length;
        var separator = separator || ",";
        var decimal   = "";

        var remainder,
            partial;

        if (amnt.indexOf(".") !== -1) {
            decimal = amnt.substr(amnt.indexOf("."), 3);
            amnt    = amnt.substr(0, amnt.indexOf("."));
            len    -= 3; // remove decimal part from total length
        }

        if (len < 4) {
            return amnt + decimal;
        } else {
            remainder = amnt.substr(0, len - 3);
            partial   = amnt.substr(len - 3, 3);

            return currency(remainder, separator) + separator + partial + decimal;
        }
    }

    /* Helper and Utility functions */

    function $(selector) {
        return _doc.querySelector(selector);
    }

    function $$(selector) {
        return _doc.querySelectorAll(selector);
    }

    var map = function(array, callback) {
        // holds the result of map operation  
        var result = [];
        var len     = array.length;
        var i;

        for (i = 0; i < len; i++) {
            result.push(callback(array[i], i));
        }

        return result;
    }

    var reduce = function(array, callback, initialValue) {

        var current = initialValue;

        var len = array.length,
            i;

        for (i = 0; i < len; i++) {
            current = callback(current, array[i]);
        }
        return current;
    };

    var filter = function(array, callback){
        //holds the result of filter operation  
        var result = [];
        var len     = array.length;
        var i;

        //for each item apply the callback
        for(i = 0; i < len; i++){
          //if callback returns true then add to the result  
          if(callback(array[i])){
              result.push(array[i]);
          }
        }
        return result;
    }

    function truthy(value) { return !!value; }

    function existy(value) { return value != null };

    function notDefined() { return void 0; }

    // A condition fulfilled causes a function application
    function execWhen(cond, fn) {
        if(truthy(cond)) {
            return fn();
        } else {
            return notDefined();
        }
    }


    /*
     * The [first] function gets an Array and an optional index as arguments, 
     * and returns the first element of the Array (or the element at the 
     * provided index, if any). If the provided index is out of range,
     * it returns the entire Array. If the first argument is not an Array, it  
     * returns the first argument provided to the function.
     * 
     */

    function first(array, idx) {

        var idx = idx || 0;

        if (existy(array[idx])) {
            return array[idx];
        } else {
            return Array.prototype.slice.call(arguments)[0];
        }
    }

    /*
     * The [rest] function gets an Array and an optional index as arguments, 
     * and returns the elements of the Array except the first one (or the  
     * element at the provided index, if any). 
     * If the provided index is out of range, it behaves just as the same as if 
     * the optional index had not been provided.
     */

    function rest(array, idx) {

        var a = Array.prototype;
        return a.slice.call(array, (idx >= 1 && idx <= array.length) ? idx : 1);
    }

    /*
     * The [without] function gets an Array and an arbitrary number of other 
     * arguments, and returns a new Array which does not contain the unwanted 
     * elements. If the first argument is not an Array, it returns an empty
     * Array instead.  
     * 
     * Example usage: 
     *
     *    without([1, 2, 3, 4], 1, 3, 7):
     *    >  [2, 4]
     *
     *    without([1, 2, 3, 4], 3);
     *    > [1, 2, 4]
     */

    function without(Array /* args */) {

        var head = Array,
            tail = rest(arguments);

        if (existy(head) && Utilities.isArray(head)) {
            // removes the unwanted elements
            return filter(head, function(item) {
              return tail.indexOf(item) === -1;
            })
        } else {
            return [];
        }
    }

    /*
     * The [cncat] function gets a variable number of arguments and returns   
     * a chain of elements (a.k.a an Array).
     */

    function cncat(/* args */) {
        // Gets the first argument
        var head = first(arguments);

        if (existy(head)) {
            // It merges both the Head and the tail into a new Array
            return [].concat.apply(head, rest(arguments));
        } else {
            return [];
        }
    }

     /*
      * Constructor Function. Like a SQL-like statement, it represents a
      * select action just like that: SELECT keys FROM list.
      *
      * For instance, it can be used as following: 
      *  
      *     Select(["name", "type"]).from(CartDB.productsDb)
      */

     function Select(keys) {
        // It allows us to invoke this function without the 'new' keyword
        if (!(this instanceof Select)) { 
            return new Select(keys); 
        }

        // A list of keys
        this.keys = keys;

        this.from = function(table) { 
            // if table exists, use the Functional Selection function 
            if (truthy(table)) {
                // it uses its homonymous Functional version
                return fSelect(table, this.keys);
            } else {
              return []; // table does not exist
            }
            
        };
     }

    /*
     * This function gets an Array (table) and a list of keys as arguments.
     * It maps each table's object and for each entry, it applies the Utility 
     * pick function for extracting the desired keys.

     * Since the 'pick' function is applied by using the built-in Javascript
     * 'apply' function which expects as its second parameter an Array of
     * arguments, the 'cncat' helper function is used to concatenate the 
     * actual object with the list of keys.
     *
     * The result of fSelect is an Array of objects containing only the wanted 
     * properties 
     */

    // fSelect :: (Array -> Array) -> Array
    function fSelect(table, keys) {
        return  map(table, function(obj) {
            keys = existy(keys) ? keys : Utilities.keys(obj);
            return Utilities.pick.apply(null, cncat(obj, [keys]));
        });
    }

    /*
     * It augments the Array prototype by adding a "where" method into it.
     * This method gets a predicate function as argument and invokes the  
     * its homonymous Functional version
     * In conjunction with the Select object, it allows to query for the 
     * properties of an object in a SQL-like manner.
     * For example the following SQL query:
     *
     * Select name, type from CartDB.productsDb Where name = 'Product-1'
     *
     * Could be translated into:
     *
     *  Select(["name", "type"]).from(CartDB.productsDb).where(function(prod) {
     *      return prod.name === 'Product-1'
     *  })
     *  
     */

    Array.prototype.where = function(pred) {
        return fWhere(this, pred);
    };

    /*
     * This function gets an Array and a predicate function as arguments and 
     * reduces the list. It returns a new partial 'table' Array everytime the 
     * predicate is true, otherwise it removes the current object from the 
     * resulting 'table'
     */

    // fWhere :: (Array -> Function) -> Array
    function fWhere(table, pred) {
        return reduce(table, function(newTable, obj) {
            if (truthy(pred(obj))) {
                return newTable;
            } else {
                return without(newTable, obj);
          }
        }, table);
    };


    function calcPercentage(value, percentage) {
      return (value - ((percentage / 100) * value)).toFixed(2);
    }

    function copyObj(first, second) {
      for (var p in first) {
        if (first.hasOwnProperty(p)) {
            second[p] = first[p];
        }
      }
      return second;
    }

    function toggle(element, visibility) {

        var display     = (window.getComputedStyle(element, null).display);
        var visibility  = visibility || 'block';

        /*
         * If the provided visibility is the same as the current one, 
         * it does nothing
         */ 
        if (element.style.display === visibility) return;

        element.style.display = (display === 'none') ? visibility : 'none';
    }

    function createHTMLElem(_doc, obj) {

      var elem = _doc.createElement(obj.tag);
      var text = ('text' in obj) ? _doc.createTextNode(obj['text']) : null;

      if (text) elem.appendChild(text);

      // it deletes unused properties 
      delete obj.tag;
      delete obj.text;

      for (var attr in obj) {
          if (obj.hasOwnProperty(attr)) {
              elem.setAttribute(attr, obj[attr]);
          }
      }

      return elem;
    }

    // This function ensures that a function will be called exactly once
    function once(fn) {

      var _once = false;

      return function () {
          return _once ? void 0 : ((_once = true), fn.apply(this, arguments))
      }
    }

    function initialize() {

        // Gets a list of promos for products of a specific type
        var types = CartDB.getPromoTypes();

        // Adds the promo code (if any) to specific products
        types.map(function(type) {

            var off  = CartDB.getPromoType(type);
            var list;

            list = $$('span[data-product-type="'+ type +'"]');

            Array.prototype.map.call(list, function(product) {

                var span = '';
                span += '<span class="product-promo            '; 
                span += '             product-promo--discount">';
                span +=  off + '% off                          ';
                span += '</span>                               ';

              // Select the parent node
              var pNode = product.parentNode.parentNode.nextSibling.nextSibling;

              // Add the SPAN element
              pNode.innerHTML += span;
            });
        });

      // Add an Event listener for each 'ADD TO CART' button
      while(len--) {
          addButtons[len].addEventListener('click', function(event) {
              addProduct(this.firstChild.nextSibling);
          })
      }

      // Set fixed shipping cost
      cartShipp.innerHTML = getCurrency(CartDB.getShippingCost());

      couponButton.addEventListener('click', checkCoupon, false);
      cartTable.addEventListener('change', changeEvent, false);
      cartTable.addEventListener('click', removeEvent, false);
    }

    function changeEvent(evt) {

        if (evt.target !== evt.currentTarget) {
            // When the target event is not the same as the event listener target 
            // a.k.a the Table-cart
              var target    = evt.target;
              var name      = target.getAttribute('data-product-name');
              var quantity  = target.value;

              if (!Utilities.isInt(quantity) || (quantity < 0)) {
                  // restore the default value 
                  target.value = target.defaultValue;
              } else if (quantity === '0') {
                    removeProduct(name);
                    return;
              }

              changeProductQuantity(name, quantity);
          }
        evt.stopPropagation();
    }

    function removeEvent(evt) {
        if (evt.target !== evt.currentTarget) {
          // When the target event is not the same as the event listener target 
          // a.k.a the Table-cart
            var clickedItem = evt.target.id;
            // The element id we are interested in has the form remove_Product-{N}
            var parts = clickedItem.split('_');
            
            if (parts[0] === 'remove') {
                removeProduct(parts[1]); // parts[1] contains the product name
            }
        }
        evt.stopPropagation();
    }

    /* Public API
    return {
      initialize: once(initialize)
    }

}

//)(window);

// Initialize the shopping cart
Cart.initialize();*/
initialize();
</script>


</body>
</html>